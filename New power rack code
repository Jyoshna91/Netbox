import pynetbox

# NetBox API connection details
NETBOX_URL = "http://10.133.35.137:8000"  # Your NetBox instance URL
NETBOX_TOKEN = "b10f953429d54bcbe45a24445161f863b202089b"  # Your API token
nb = pynetbox.api(NETBOX_URL, token=NETBOX_TOKEN)

# Fetch Nexus switches (adjust filter as needed)
nexus_switches = nb.dcim.devices.filter(device_type__model="Nexus9000")

for switch in nexus_switches:
    print(f"Device Name: {switch.name}")
    
    if switch.rack:
        print(f"Rack: {switch.rack.name}")
        print(f"Rack Position: U{switch.position} (Front)")

        # Rack space utilization
        rack = nb.dcim.racks.get(switch.rack.id)
        print(f"Total Rack Units: {rack.u_height}")
        
        # Corrected way to calculate used rack units
        used_units = sum(device.device_type.u_height for device in nb.dcim.devices.filter(rack_id=rack.id))
        print(f"Used Rack Units: {used_units}")

        # Retrieve space utilization and power utilization1 from custom fields
        space_utilization = rack.custom_fields.get('space_utilization', 'N/A')
        power_utilization1 = rack.custom_fields.get('Power_utilization1', 'N/A')
        
        print(f"Space Utilization: {space_utilization}")
        print(f"Power utilization1: {power_utilization1}")
